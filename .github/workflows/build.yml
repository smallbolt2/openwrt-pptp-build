name: Build PPTP IPK

on:
  push:
    branches: [ main ]

jobs:
  build-ipk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OpenWrt SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev unzip python3
          SDK_URL="https://downloads.openwrt.org/releases/21.02.7/targets/ramips/mt7621/openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64.tar.xz"
          wget $SDK_URL
          tar -xvf openwrt-sdk-*.tar.xz
          mv openwrt-sdk-* openwrt-sdk

          # 验证 SDK 完整性
          if [ ! -f "openwrt-sdk/Config.in" ]; then
            echo "Error: SDK missing key files!"
            exit 1
          fi

      - name: Prepare PPTP source
        run: |
          cp pptp-linux_1.10.0.orig.tar.gz openwrt-sdk/
          mkdir -p openwrt-sdk/package/pptp-linux
          cp -r package/pptp-linux/* openwrt-sdk/package/pptp-linux/

          # 生成 Config.in
          echo "config PACKAGE_pptp-linux" > openwrt-sdk/package/pptp-linux/Config.in
          echo "    bool \"PPTP Client for Linux\"" >> openwrt-sdk/package/pptp-linux/Config.in
          echo "    default n" >> openwrt-sdk/package/pptp-linux/Config.in
          echo "    help" >> openwrt-sdk/package/pptp-linux/Config.in
          echo "        PPTP client implementation for Linux." >> openwrt-sdk/package/pptp-linux/Config.in

      - name: Compile IPK
        run: |
          cd openwrt-sdk
          echo "src-link custom $(pwd)/package" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 调试：查看目录结构
          ls -lR package/pptp-linux

          make defconfig
          echo "CONFIG_PACKAGE_pptp-linux=y" >> .config
          make package/pptp-linux/compile V=s

      - name: Upload IPK
        uses: actions/upload-artifact@v4
        with:
          name: pptp-ipk
          path: openwrt-sdk/bin/packages/mipsel_24kc/base/pptp-linux_*.ipk
